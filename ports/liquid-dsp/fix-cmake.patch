From fcbbcbaf04ef1017647b4718dd06146c2af73518 Mon Sep 17 00:00:00 2001
From: myd7349 <myd7349@gmail.com>
Date: Sat, 1 Mar 2025 17:50:33 +0800
Subject: [PATCH] cmake: fix version parsing on Windows

---
 CMakeLists.txt      |  7 +++----
 cmake/version.cmake | 22 ++++++++++++++++++++++
 2 files changed, 25 insertions(+), 4 deletions(-)
 create mode 100644 cmake/version.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index fad0497f..7a9bdcf7 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,10 +1,9 @@
 # cmake build file for liquid-dsp
 cmake_minimum_required(VERSION 3.10)
 
-# run custom command to parse version number from include/liquid.h
-execute_process(COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/scripts/version.sh
-    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
-    OUTPUT_VARIABLE LIQUID_VERSION)
+# parse version number from include/liquid.h
+include(cmake/version.cmake)
+get_liquid_version("${CMAKE_CURRENT_SOURCE_DIR}/include/liquid.h" LIQUID_VERSION)
 
 # project definition
 project(liquid VERSION ${LIQUID_VERSION} LANGUAGES C CXX)
diff --git a/cmake/version.cmake b/cmake/version.cmake
new file mode 100644
index 00000000..8999e0b5
--- /dev/null
+++ b/cmake/version.cmake
@@ -0,0 +1,22 @@
+function(get_liquid_version HEADER_FILE OUTPUT_VAR)
+    if (NOT EXISTS "${HEADER_FILE}")
+        message(FATAL_ERROR "No ${HEADER_FILE} found!")
+    endif()
+
+    file(READ "${HEADER_FILE}" HEADER_CONTENTS)
+
+    string(REGEX MATCH "#define[ \t]+LIQUID_VERSION_MAJOR[ \t]+([0-9]+)" _ ${HEADER_CONTENTS})
+    set(VERSION_MAJOR ${CMAKE_MATCH_1})
+
+    string(REGEX MATCH "#define[ \t]+LIQUID_VERSION_MINOR[ \t]+([0-9]+)" _ ${HEADER_CONTENTS})
+    set(VERSION_MINOR ${CMAKE_MATCH_1})
+
+    string(REGEX MATCH "#define[ \t]+LIQUID_VERSION_PATCH[ \t]+([0-9]+)" _ ${HEADER_CONTENTS})
+    set(VERSION_PATCH ${CMAKE_MATCH_1})
+
+    if (VERSION_MAJOR STREQUAL "" OR VERSION_MINOR STREQUAL "" OR VERSION_PATCH STREQUAL "")
+        message(FATAL_ERROR "Could not extract version from ${HEADER_FILE}!")
+    endif()
+
+    set(${OUTPUT_VAR} "${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_PATCH}" PARENT_SCOPE)
+endfunction()
-- 
2.43.0

